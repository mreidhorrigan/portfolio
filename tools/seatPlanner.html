<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seat Planner</title>
<style>
  /* ── Palette ────────────────────────────────────────────────────────────────
     Navy        #0C2F56   primary text, buttons, badges
     Deep Blue   #152A4E   button hover
     Dark Red    #B2241A   eyebrow, dragover, error, flags
     Gold        #F2CC56   swap flash, grade badge bg
     Gold dark   #D4A800   confirmed upload border
     Off-white   #F7F5F0   page background
     Blue tint   #EEF3F8   filled seats, notices, stat bg
  ──────────────────────────────────────────────────────────────────────────── */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: system-ui, sans-serif;
    background: #F7F5F0;
    color: #0C2F56;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: radial-gradient(circle, rgba(12,47,86,0.07) 1px, transparent 1px);
    background-size: 36px 36px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 960px;
    margin: 0 auto;
    padding: 56px 32px 80px;
  }

  /* ── Header ─────────────────────────────────────────────────────────────── */
  header { margin-bottom: 2rem; }

  .eyebrow {
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: #B2241A;
    margin-bottom: 0.3rem;
  }

  h1 {
    font-size: 1.8rem;
    font-weight: 800;
    color: #0C2F56;
    line-height: 1.15;
    margin-bottom: 0.2rem;
  }

  h1 em { font-style: normal; color: #B2241A; }

  .subtitle {
    color: #4a5e74;
    font-size: 0.92rem;
    line-height: 1.5;
    max-width: 560px;
    margin-top: 0.3rem;
  }

  .subtitle strong { color: #0C2F56; font-weight: 700; }

  /* ── Upload cards ────────────────────────────────────────────────────────── */
  .uploads {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.1rem;
    margin-bottom: 1.1rem;
  }

  @media (max-width: 580px) { .uploads { grid-template-columns: 1fr; } }

  .upload-card {
    border: 2px dashed #C8D8E8;
    border-radius: 10px;
    padding: 1.4rem 1.5rem;
    cursor: pointer;
    transition: border-color 0.18s, background 0.18s;
    position: relative;
    background: #FFFFFF;
  }

  .upload-card:hover, .upload-card.dragover {
    border-color: #B2241A;
    background: #fdf3f2;
  }

  .upload-card.loaded {
    border-style: solid;
    border-color: #D4A800;
    background: #fffbee;
  }

  .upload-card input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .card-label {
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: #B2241A;
    margin-bottom: 0.35rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .card-label .optional {
    font-weight: 500;
    text-transform: none;
    letter-spacing: 0;
    background: #EEF3F8;
    color: #0C2F56;
    font-size: 0.72rem;
    padding: 0.1rem 0.45rem;
    border-radius: 4px;
  }

  .card-title {
    font-size: 1.05rem;
    font-weight: 700;
    margin-bottom: 0.3rem;
    color: #0C2F56;
  }

  .card-hint {
    font-size: 0.76rem;
    color: #7a8fa6;
    line-height: 1.55;
  }

  .card-status {
    margin-top: 0.5rem;
    font-size: 0.76rem;
    color: #7a6000;
    font-weight: 700;
    min-height: 1rem;
  }

  .upload-card.loaded .card-status::before { content: '✓ '; }

  /* ── Notice bar ──────────────────────────────────────────────────────────── */
  .notice {
    font-size: 0.85rem;
    color: #0C2F56;
    margin-bottom: 1.1rem;
    padding: 0.5rem 0.9rem;
    background: #EEF3F8;
    border-left: 3px solid #0C2F56;
    border-radius: 0 6px 6px 0;
    line-height: 1.6;
  }

  .notice strong { font-weight: 700; }

  .notice.grade-mode {
    border-left-color: #D4A800;
    background: #fffbee;
    color: #7a6000;
  }

  .notice.grade-mode strong { color: #7a6000; }

  /* ── Buttons ─────────────────────────────────────────────────────────────── */
  .controls {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .btn {
    font-family: system-ui, sans-serif;
    font-size: 0.9rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    padding: 0.55rem 1.3rem;
    border: 2px solid #0C2F56;
    border-radius: 8px;
    background: #0C2F56;
    color: #FFFFFF;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s, opacity 0.15s, transform 0.1s;
  }

  .btn:hover { background: #152A4E; border-color: #152A4E; }
  .btn:active { transform: translateY(1px); }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; }

  .btn-secondary { background: transparent; color: #0C2F56; }
  .btn-secondary:hover { background: #0C2F56; color: #FFFFFF; }

  .btn-pdf {
    background: #B2241A;
    border-color: #B2241A;
    color: #FFFFFF;
  }
  .btn-pdf:hover { background: #8f1b13; border-color: #8f1b13; }

  .btn-undo {
    background: transparent;
    color: #7a8fa6;
    border-color: #C8D8E8;
    font-size: 0.83rem;
    padding: 0.5rem 1rem;
  }
  .btn-undo:hover { background: #0C2F56; color: #FFFFFF; border-color: #0C2F56; }
  .btn-undo:disabled { opacity: 0.25; }

  /* ── Preview section ─────────────────────────────────────────────────────── */
  .preview-section { display: none; animation: fadeIn 0.35s ease; }
  .preview-section.visible { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .section-label {
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: #7a8fa6;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #C8D8E8;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .drag-hint {
    font-size: 0.75rem;
    color: #7a8fa6;
    font-style: italic;
    letter-spacing: 0;
    text-transform: none;
    font-weight: 400;
  }

  /* ── Stats ───────────────────────────────────────────────────────────────── */
  .stats-row {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1rem;
    padding: 0.75rem 1rem;
    background: #EEF3F8;
    border: 1px solid #C8D8E8;
    border-radius: 8px;
    flex-wrap: wrap;
  }

  .stat { display: flex; flex-direction: column; gap: 1px; }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 800;
    color: #0C2F56;
    line-height: 1;
  }

  .stat-label {
    font-size: 0.72rem;
    color: #7a8fa6;
    font-weight: 500;
    letter-spacing: 0.04em;
  }

  /* ── Swap log ────────────────────────────────────────────────────────────── */
  .swap-log {
    font-size: 0.83rem;
    color: #4a5e74;
    margin-bottom: 1rem;
    min-height: 1.2rem;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }

  .swap-log-text { flex: 1; }
  .swap-log-text strong { color: #0C2F56; font-weight: 700; }

  .swap-badge {
    display: inline-block;
    background: #B2241A;
    color: #FFFFFF;
    font-size: 0.72rem;
    font-weight: 700;
    padding: 0.15rem 0.55rem;
    border-radius: 999px;
    letter-spacing: 0.03em;
  }

  /* ── Grid ────────────────────────────────────────────────────────────────── */
  .grid-preview {
    overflow-x: auto;
    margin-bottom: 1.5rem;
    border: 1px solid #C8D8E8;
    border-radius: 10px;
    background: #FFFFFF;
    padding: 1.25rem;
    user-select: none;
    box-shadow: 0 2px 12px rgba(12,47,86,0.07);
  }

  .grid-table {
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.8rem;
  }

  .grid-table td {
    min-width: 110px;
    width: 110px;
    height: 48px;
    text-align: center;
    border-top:    1px solid #dde6ef;
    border-left:   1px solid #dde6ef;
    border-right:  1px solid #dde6ef;
    border-bottom: 1px solid #dde6ef;
    padding: 4px 6px;
    vertical-align: middle;
    white-space: normal;
    word-break: break-word;
    line-height: 1.3;
    color: #b0bfcc;
    transition: background 0.12s, box-shadow 0.12s;
    position: relative;
  }

  /* Filled seat */
  .cell-filled {
    background: #EEF3F8;
    border-top-color:    #B8CCE0 !important;
    border-left-color:   #B8CCE0 !important;
    border-right-color:  #B8CCE0 !important;
    border-bottom-color: #B8CCE0 !important;
    color: #0C2F56;
    font-weight: 600;
    cursor: grab;
  }

  .cell-filled:hover {
    background: #dce8f4;
    box-shadow: 0 2px 8px rgba(12,47,86,0.12);
    z-index: 2;
  }

  .cell-empty-seat {
    background: #fafbfc;
    border-top-color:    #e4ecf3 !important;
    border-left-color:   #e4ecf3 !important;
    border-right-color:  #e4ecf3 !important;
    border-bottom-color: #e4ecf3 !important;
    color: #b0bfcc;
    font-style: italic;
    font-size: 0.72rem;
  }

  .cell-spacer {
    background: transparent;
    border-color: transparent !important;
  }

  /* Grade badge */
  .grade-badge {
    display: inline-block;
    background: #F2CC56;
    color: #6b4e00;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 1px 5px;
    border-radius: 4px;
    letter-spacing: 0.03em;
    line-height: 1.4;
  }

  /* Integrity flag marker */
  .flag-marker {
    display: inline-flex;
    align-items: center;
    background: rgba(178,36,26,0.12);
    color: #B2241A;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 1px 5px;
    border-radius: 4px;
    line-height: 1.4;
    border: 1px solid rgba(178,36,26,0.25);
  }

  /* Flagged cell: red left-border accent */
  .cell-filled.has-flag {
    border-left-color: #B2241A !important;
    border-left-width: 3px !important;
  }

  /* Cell inner layout */
  .cell-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    height: 100%;
  }

  .badges-row {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* Hide all details when toggle is off */
  .grid-table.details-off .badges-row { display: none; }
  .grid-table.details-off .grade-badge,
  .grid-table.details-off .flag-marker { display: none; }
  .grid-table.details-off .cell-filled.has-flag {
    border-left-color: #B8CCE0 !important;
    border-left-width: 1px !important;
  }

  /* Show Details toggle button */
  .btn-toggle-details {
    background: transparent;
    color: #7a8fa6;
    border-color: #C8D8E8;
    font-size: 0.83rem;
    padding: 0.5rem 1rem;
  }
  .btn-toggle-details:hover { background: #0C2F56; color: #FFFFFF; border-color: #0C2F56; }
  .btn-toggle-details.active { background: #0C2F56; color: #FFFFFF; border-color: #0C2F56; }

  /* Drag states */
  .cell-filled.dragging { opacity: 0.35; cursor: grabbing; }

  .cell-filled.drag-over,
  .cell-empty-seat.drag-over {
    background: rgba(178,36,26,0.08) !important;
    border-top-color:    #B2241A !important;
    border-left-color:   #B2241A !important;
    border-right-color:  #B2241A !important;
    border-bottom-color: #B2241A !important;
    box-shadow: inset 0 0 0 1px #B2241A;
    color: #B2241A;
  }

  /* Swap flash */
  @keyframes swapFlash {
    0%   { background: rgba(242,204,86,0.55); }
    60%  { background: rgba(242,204,86,0.2); }
    100% { background: #EEF3F8; }
  }
  .cell-just-swapped { animation: swapFlash 0.5s ease forwards; }

  /* ── Error ───────────────────────────────────────────────────────────────── */
  .error-msg {
    background: #fdf3f2;
    border-left: 3px solid #B2241A;
    border-radius: 0 6px 6px 0;
    padding: 0.5rem 0.9rem;
    font-size: 0.85rem;
    color: #B2241A;
    margin-bottom: 1rem;
    display: none;
  }
  .error-msg.visible { display: block; }

  /* ── Drag ghost ──────────────────────────────────────────────────────────── */
  #drag-ghost {
    position: fixed;
    pointer-events: none;
    background: #0C2F56;
    color: #FFFFFF;
    font-family: system-ui, sans-serif;
    font-size: 0.83rem;
    font-weight: 700;
    padding: 5px 14px;
    border-radius: 999px;
    box-shadow: 0 4px 16px rgba(12,47,86,0.25);
    z-index: 9999;
    display: none;
    white-space: nowrap;
  }

  /* ══════════════════════════════════════════════════════════════════════════
     PRINT / PDF STYLES
  ══════════════════════════════════════════════════════════════════════════ */
  @media print {
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

    body { background: #fff !important; }
    body::before { display: none; }

    .container > header,
    .uploads,
    .notice,
    .error-msg,
    .controls,
    .section-label,
    .stats-row,
    .swap-log,
    .drag-hint,
    #drag-ghost { display: none !important; }

    .preview-section {
      display: block !important;
      animation: none !important;
    }

    .grid-preview {
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      overflow: visible !important;
      margin: 0 !important;
    }

    #print-header { display: block !important; }

    .grid-table {
      width: 100% !important;
      table-layout: fixed !important;
      border-collapse: separate !important;
      border-spacing: 0 !important;
      font-size: 9px !important;
      font-family: system-ui, sans-serif !important;
    }

    .grid-table td {
      min-width: 0 !important;
      width: auto !important;
      height: 30px !important;
      padding: 3px !important;
      white-space: normal !important;
      word-break: break-word !important;
      line-height: 1.2 !important;
      vertical-align: middle !important;
      border-top:    1px solid #B8CCE0 !important;
      border-left:   1px solid #B8CCE0 !important;
      border-right:  1px solid #B8CCE0 !important;
      border-bottom: 1px solid #B8CCE0 !important;
      color: #aabbcc !important;
    }

    .cell-filled {
      background: #EEF3F8 !important;
      border-top-color:    #9ab5ce !important;
      border-left-color:   #9ab5ce !important;
      border-right-color:  #9ab5ce !important;
      border-bottom-color: #9ab5ce !important;
      color: #0C2F56 !important;
      font-weight: 700 !important;
    }

    .cell-empty-seat {
      background: #f8fafc !important;
      border-top-color:    #ccdae6 !important;
      border-left-color:   #ccdae6 !important;
      border-right-color:  #ccdae6 !important;
      border-bottom-color: #ccdae6 !important;
      color: #c0cdd8 !important;
    }

    .cell-spacer {
      background: #ffffff !important;
      border-color: transparent !important;
    }

    /* Badges suppressed in PDF */
    .grade-badge,
    .flag-marker { display: none !important; }

    .cell-filled.has-flag {
      border-left-color: #9ab5ce !important;
      border-left-width: 1px !important;
    }
  }
</style>
</head>
<body>

<div id="drag-ghost"></div>

<div class="container">

  <!-- ── Header ── -->
  <header>
    <p class="eyebrow">Seat Planner · v10</p>
    <h1>Generate a <em>seating plan</em></h1>
    <p class="subtitle">Upload a student list and a classroom layout — both in CSV format — to generate a seating plan. Then <strong>drag any student onto another</strong> to swap their seats. The CSV updates automatically.</p>
  </header>

  <!-- ── File uploads ── -->
  <div class="uploads">
    <div class="upload-card" id="card-students">
      <input type="file" accept=".csv" id="input-students">
      <div class="card-label">Student Names CSV</div>
      <div class="card-title">Student Names</div>
      <div class="card-hint">
        Column 1: name &nbsp;·&nbsp; Column 2 (optional): grade<br>
        Column 3 (optional): any text adds a red flag<br>
        for academic integrity observation.
      </div>
      <div class="card-status" id="status-students"></div>
    </div>

    <div class="upload-card" id="card-layout">
      <input type="file" accept=".csv" id="input-layout">
      <div class="card-label">Classroom Layout CSV <span class="optional">optional</span></div>
      <div class="card-title">Classroom Layout</div>
      <div class="card-hint">Cells with "X" mark valid seat positions.<br>Leave blank to use the default layout.</div>
      <div class="card-status" id="status-layout"></div>
    </div>
  </div>

  <!-- Notice bar — updated dynamically -->
  <div class="notice" id="main-notice">
    <strong>Default layout active:</strong> 5 rows × 9 columns with two aisle gaps — 35 seats total. Upload a layout CSV above to override.
  </div>

  <div class="error-msg" id="error-msg"></div>

  <!-- ── Controls ── -->
  <div class="controls">
    <button class="btn"               id="btn-assign"   disabled>Assign Seats</button>
    <button class="btn btn-secondary" id="btn-download" style="display:none">Download CSV</button>
    <button class="btn btn-secondary" id="btn-reassign" style="display:none">Reassign (Shuffle)</button>
    <button class="btn btn-pdf"       id="btn-pdf"      style="display:none">Download PDF</button>
    <button class="btn btn-toggle-details" id="btn-toggle-details" style="display:none">Show Details</button>
    <button class="btn btn-undo"      id="btn-undo"     style="display:none" disabled>↩ Undo Swap</button>
  </div>

  <!-- ── Preview ── -->
  <div class="preview-section" id="preview-section">

    <!-- Print-only header -->
    <div id="print-header" style="display:none; font-family:Arial,sans-serif;">
      <div style="display:flex; align-items:baseline; justify-content:space-between; margin-bottom:12px; border-bottom:2px solid #0C2F56; padding-bottom:8px;">
        <div>
          <div style="font-size:8px; letter-spacing:0.14em; text-transform:uppercase; color:#B2241A; margin-bottom:4px;">Seat Planner</div>
          <div style="font-size:18px; font-weight:300; color:#0C2F56;">Seating Plan</div>
        </div>
        <div id="print-meta" style="font-size:9px; color:#5c7a9a; text-align:right; line-height:1.7;"></div>
      </div>
    </div>

    <div class="section-label">
      <span>Seating Chart Preview</span>
      <span class="drag-hint">drag a student onto another to swap</span>
    </div>
    <div class="stats-row" id="stats-row"></div>
    <div class="swap-log"  id="swap-log"></div>
    <div class="grid-preview">
      <table class="grid-table" id="grid-table"></table>
    </div>
  </div>

</div>

<script>
  // ── Default layout ─────────────────────────────────────────────────────────
  // 5 rows, 9 cols: X X _ X X X _ X X
  const DEFAULT_LAYOUT = (function() {
    const pattern = ['X','X','','X','X','X','','X','X'];
    return Array.from({ length: 5 }, () => [...pattern]);
  })();

  // ── State ──────────────────────────────────────────────────────────────────
  let studentsData = null;  // [{name, grade, flagged}] — grade null if absent, flagged bool
  let gradesPresent = false;
  let flagsPresent  = false;
  let detailsVisible = false;   // grade badges + flag markers hidden by default
  let layoutData   = DEFAULT_LAYOUT;
  let resultGrid   = null;  // 2D array of name strings
  let gradeGrid    = null;  // 2D array of grade values (null where absent)
  let flagGrid     = null;  // 2D array of booleans (true = flagged)
  let swapHistory  = [];
  let swapCount    = 0;
  let dragSrc      = null;
  let totalSeatsGlobal = 0, totalStudentsGlobal = 0, assignedGlobal = 0;

  // ── DOM refs ───────────────────────────────────────────────────────────────
  const inputStudents  = document.getElementById('input-students');
  const inputLayout    = document.getElementById('input-layout');
  const cardStudents   = document.getElementById('card-students');
  const cardLayout     = document.getElementById('card-layout');
  const statusStudents = document.getElementById('status-students');
  const statusLayout   = document.getElementById('status-layout');
  const btnAssign      = document.getElementById('btn-assign');
  const btnDownload    = document.getElementById('btn-download');
  const btnReassign    = document.getElementById('btn-reassign');
  const btnPdf         = document.getElementById('btn-pdf');
  const btnToggle      = document.getElementById('btn-toggle-details');
  const btnUndo        = document.getElementById('btn-undo');
  const previewSection = document.getElementById('preview-section');
  const gridTable      = document.getElementById('grid-table');
  const statsRow       = document.getElementById('stats-row');
  const errorMsg       = document.getElementById('error-msg');
  const swapLogEl      = document.getElementById('swap-log');
  const dragGhost      = document.getElementById('drag-ghost');
  const printMeta      = document.getElementById('print-meta');
  const printHeader    = document.getElementById('print-header');
  const mainNotice     = document.getElementById('main-notice');

  // ── CSV parsing ────────────────────────────────────────────────────────────
  function parseCSV(text) {
    return text.trim().split('\n').map(row =>
      row.split(',').map(cell => cell.replace(/^"|"$/g, '').trim())
    );
  }

  function showError(msg) { errorMsg.textContent = msg; errorMsg.classList.add('visible'); }
  function clearError()   { errorMsg.classList.remove('visible'); }
  function checkReady()   { btnAssign.disabled = !studentsData; }

  function isSeat(r, c) {
    return layoutData[r] && layoutData[r][c] !== undefined && layoutData[r][c].toUpperCase() === 'X';
  }

  function updateNotice() {
    const layoutIsDefault = layoutData === DEFAULT_LAYOUT;
    const parts = [];

    if (layoutIsDefault) {
      parts.push('<strong>Default layout active:</strong> 5 rows × 9 columns with two aisle gaps — 35 seats total. Upload a layout CSV above to override.');
    }

    if (gradesPresent) {
      const msg = 'Grade mode active: students will be placed with lower grades toward the <strong>bottom-left</strong>. Shuffling is disabled — grades determine placement.';
      if (parts.length) {
        parts.push(msg);
      } else {
        parts.push(msg);
      }
      mainNotice.className = 'notice grade-mode';
    } else {
      mainNotice.className = 'notice';
    }

    if (parts.length) {
      mainNotice.style.display = '';
      mainNotice.innerHTML = parts.join('<br>');
    } else {
      mainNotice.style.display = 'none';
    }
  }

  // ── File: students ─────────────────────────────────────────────────────────
  inputStudents.addEventListener('change', e => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const rows = parseCSV(ev.target.result);
      // Filter out blank rows and optional header
      const dataRows = rows.filter(r => r[0] && r[0].toLowerCase() !== 'name');

      // Detect grades: col 2 present and numeric on every row
      const hasGrades = dataRows.length > 0 &&
        dataRows.every(r => r[1] !== undefined && r[1] !== '' && !isNaN(parseFloat(r[1])));

      // Detect flags: col 3 present and non-empty on at least one row
      const hasFlags = dataRows.some(r => r[2] !== undefined && r[2].trim() !== '');

      gradesPresent = hasGrades;
      flagsPresent  = hasFlags;

      studentsData = dataRows.map(r => ({
        name:    r[0],
        grade:   hasGrades ? parseFloat(r[1]) : null,
        flagged: (r[2] !== undefined && r[2].trim() !== '')
      }));

      const notes = [];
      if (hasGrades) notes.push('grades detected');
      if (hasFlags)  notes.push('integrity flags detected');
      statusStudents.textContent = `${studentsData.length} students loaded` +
        (notes.length ? ' · ' + notes.join(', ') : '');
      cardStudents.classList.add('loaded');
      checkReady();
      updateNotice();

      // Show/hide Reassign button depending on mode
      if (previewSection.classList.contains('visible')) {
        btnReassign.style.display = gradesPresent ? 'none' : '';
      }
    };
    reader.readAsText(file);
  });

  // ── File: layout ───────────────────────────────────────────────────────────
  inputLayout.addEventListener('change', e => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      layoutData = parseCSV(ev.target.result);
      const seats = layoutData.flat().filter(c => c.toUpperCase() === 'X').length;
      statusLayout.textContent = `${layoutData.length} rows × ${layoutData[0].length} cols — ${seats} seats`;
      cardLayout.classList.add('loaded');
      updateNotice();
    };
    reader.readAsText(file);
  });

  // Drag-and-drop file onto upload cards
  [cardStudents, cardLayout].forEach(card => {
    card.addEventListener('dragover', e => { e.preventDefault(); card.classList.add('dragover'); });
    card.addEventListener('dragleave', () => card.classList.remove('dragover'));
    card.addEventListener('drop', e => {
      e.preventDefault();
      card.classList.remove('dragover');
      const input = card.querySelector('input[type="file"]');
      const file = e.dataTransfer.files[0];
      if (file) {
        const dt = new DataTransfer(); dt.items.add(file);
        input.files = dt.files;
        input.dispatchEvent(new Event('change'));
      }
    });
  });

  // ── Assign ─────────────────────────────────────────────────────────────────
  btnAssign.addEventListener('click',   () => assign());
  btnReassign.addEventListener('click', () => assign());

  function assign() {
    clearError();

    // Collect all seat positions
    const seats = [];
    for (let r = 0; r < layoutData.length; r++)
      for (let c = 0; c < layoutData[r].length; c++)
        if (layoutData[r][c] && layoutData[r][c].toUpperCase() === 'X') seats.push([r, c]);

    if (!seats.length)                            { showError('No seats found. Make sure the layout CSV has cells containing "X".'); return; }
    if (!studentsData || !studentsData.length)    { showError('No student names found.'); return; }

    // Determine which students get seats
    const count = Math.min(studentsData.length, seats.length);

    // Build ordered seat list and ordered student list depending on mode
    let orderedSeats, orderedStudents;

    if (gradesPresent) {
      // ── Grade mode (spread + ordered) ─────────────────────────────────────
      //
      // Goal: students are evenly spread throughout the room AND lower-graded
      // students sit further toward the bottom-left.
      //
      // Algorithm:
      //   1. Use farthest-point sampling to choose `count` well-spread seats
      //      from all available seats — this gives us good spatial coverage.
      //   2. Assign each chosen seat a "bottom-left score":
      //        score = (maxRow - row) + col
      //      where maxRow is the highest row index in the layout.
      //      Score 0 = most bottom-left; higher score = more top-right.
      //   3. Sort the chosen seats by score ascending (bottom-left first).
      //   4. Sort students by grade ascending (lowest grade first).
      //   5. Pair them in order: lowest-grade student → most bottom-left seat.
      //
      // Result: even spread across the room, with grade increasing
      // geometrically from bottom-left to top-right.

      // Step 1: pick spread-out seats
      const spreadSeats = farthestPointSampling(seats, count);

      // Step 2 & 3: sort spread seats so that bottom rows come first,
      // with column (left→right) used only to break ties within the same row.
      // This guarantees no lower-graded student ever sits in a higher row
      // than a higher-graded student — row position is strictly respected.
      orderedSeats = [...spreadSeats].sort((a, b) =>
        a[0] !== b[0]
          ? b[0] - a[0]   // primary:   row descending  (higher index = lower in room)
          : a[1] - b[1]   // tiebreaker: col ascending  (left before right)
      );

      // Step 4: sort students lowest grade first; flagged students are treated
      // as grade -Infinity so they always sort to the very front and land in
      // the bottom-most seats regardless of their actual grade.
      orderedStudents = [...studentsData]
        .sort((a, b) => {
          const ea = a.flagged ? -Infinity : (a.grade ?? 0);
          const eb = b.flagged ? -Infinity : (b.grade ?? 0);
          return ea - eb;
        })
        .slice(0, count);
    } else {
      // ── Normal mode (evenly spaced) ────────────────────────────────────────
      orderedSeats = farthestPointSampling(seats, count);

      // If flags are present, flagged students go to the bottom-most seats.
      // Sort the chosen seats bottom-first (same key as grade mode), then
      // place flagged students there and shuffle the rest into remaining seats.
      if (flagsPresent) {
        const sortedSeats = [...orderedSeats].sort((a, b) =>
          a[0] !== b[0] ? b[0] - a[0] : a[1] - b[1]
        );
        const flaggedStudents   = studentsData.filter(s => s.flagged).sort(() => Math.random() - 0.5);
        const unflaggedStudents = studentsData.filter(s => !s.flagged).sort(() => Math.random() - 0.5);
        orderedSeats    = sortedSeats;
        orderedStudents = [...flaggedStudents, ...unflaggedStudents].slice(0, count);
      } else {
        orderedStudents = [...studentsData]
          .sort(() => Math.random() - 0.5)
          .slice(0, count)
          .map(s => ({ ...s }));
      }
    }

    // Build result grids
    const rows = layoutData.length;
    const cols = Math.max(...layoutData.map(r => r.length));

    resultGrid = Array.from({ length: rows }, (_, r) =>
      Array.from({ length: cols }, (_, c) => {
        const v = layoutData[r] && layoutData[r][c] !== undefined ? layoutData[r][c] : '';
        return v.toUpperCase() === 'X' ? '' : v;
      })
    );

    gradeGrid = Array.from({ length: rows }, () => Array(cols).fill(null));
    flagGrid  = Array.from({ length: rows }, () => Array(cols).fill(false));

    for (let i = 0; i < orderedSeats.length; i++) {
      const [r, c] = orderedSeats[i];
      const student = orderedStudents[i];
      if (!student) break;
      resultGrid[r][c] = student.name;
      gradeGrid[r][c]  = student.grade;    // null when no grades
      flagGrid[r][c]   = student.flagged || false;
    }

    swapHistory = []; swapCount = 0;
    updateSwapLog(null);

    totalSeatsGlobal    = seats.length;
    totalStudentsGlobal = studentsData.length;
    assignedGlobal      = orderedSeats.length;

    renderPreview(seats.length, studentsData.length, orderedSeats.length);
  }

  // ── Farthest-point sampling (no-grade mode) ────────────────────────────────
  function euclidean(a, b) { return Math.sqrt((a[0]-b[0])**2 + (a[1]-b[1])**2); }

  function farthestPointSampling(seats, count) {
    if (!seats.length || !count) return [];
    const result  = [seats[Math.floor(Math.random() * seats.length)]];
    const minDist = new Array(seats.length).fill(Infinity);
    while (result.length < count) {
      const last = result[result.length - 1];
      let farthestIdx = 0, farthestDist = -1;
      for (let i = 0; i < seats.length; i++) {
        const d = euclidean(seats[i], last);
        if (d < minDist[i]) minDist[i] = d;
        if (minDist[i] > farthestDist) { farthestDist = minDist[i]; farthestIdx = i; }
      }
      result.push(seats[farthestIdx]);
    }
    return result;
  }

  // ── Render preview ─────────────────────────────────────────────────────────
  function renderPreview(totalSeats, totalStudents, assigned) {
    statsRow.innerHTML = `
      <div class="stat"><span class="stat-value">${totalStudents}</span><span class="stat-label">students</span></div>
      <div class="stat"><span class="stat-value">${totalSeats}</span><span class="stat-label">seats</span></div>
      <div class="stat"><span class="stat-value">${assigned}</span><span class="stat-label">assigned</span></div>
      <div class="stat"><span class="stat-value">${totalSeats - assigned}</span><span class="stat-label">empty seats</span></div>
    `;

    // Reset details visibility on each new assignment
    detailsVisible = false;
    gridTable.classList.add('details-off');
    btnToggle.textContent = 'Show Details';
    btnToggle.classList.remove('active');

    rebuildTable();
    previewSection.classList.add('visible');
    btnDownload.style.display = '';
    btnReassign.style.display = gradesPresent ? 'none' : '';
    btnPdf.style.display      = '';
    // Show toggle button only when there's something to toggle
    btnToggle.style.display   = (gradesPresent || flagsPresent) ? '' : 'none';
    btnUndo.style.display     = '';
    syncUndoBtn();
  }

  function rebuildTable(flashCells) {
    gridTable.innerHTML = '';
    const rows = resultGrid.length;
    const cols = Math.max(...resultGrid.map(r => r.length));

    for (let r = 0; r < rows; r++) {
      const tr = document.createElement('tr');
      for (let c = 0; c < cols; c++) {
        const td      = document.createElement('td');
        const val     = resultGrid[r] ? (resultGrid[r][c] || '') : '';
        const grade   = (gradeGrid && gradeGrid[r]) ? gradeGrid[r][c] : null;
        const flagged = (flagGrid  && flagGrid[r])  ? flagGrid[r][c]  : false;
        const seat    = isSeat(r, c);

        td.dataset.r = r;
        td.dataset.c = c;

        if (seat && val) {
          td.className = 'cell-filled' + (flagged ? ' has-flag' : '');

          const gradeLabel = grade !== null ? ' · Grade ' + grade : '';
          const flagLabel  = flagged ? ' · ⚑ integrity flag' : '';
          td.title = `${val}${gradeLabel}${flagLabel} — drag to swap`;

          // Always build the inner layout; CSS hides badges when details-off
          const inner = document.createElement('div');
          inner.className = 'cell-inner';

          const nameSpan = document.createElement('span');
          nameSpan.textContent = val;
          inner.appendChild(nameSpan);

          // Grade badge and flag marker share a single badges-row
          if (grade !== null || flagged) {
            const badgesRow = document.createElement('div');
            badgesRow.className = 'badges-row';

            if (grade !== null) {
              const badge = document.createElement('span');
              badge.className = 'grade-badge';
              badge.textContent = 'Gr. ' + grade;
              badgesRow.appendChild(badge);
            }

            if (flagged) {
              const marker = document.createElement('span');
              marker.className = 'flag-marker';
              marker.textContent = '⚑';
              marker.title = 'Academic integrity flag';
              badgesRow.appendChild(marker);
            }

            inner.appendChild(badgesRow);
          }

          td.appendChild(inner);
          attachDragHandlers(td);

        } else if (seat) {
          td.className = 'cell-empty-seat';
          td.textContent = 'empty';
          attachDropOnlyHandlers(td);
        } else {
          td.className = 'cell-spacer';
        }

        if (flashCells && flashCells.some(([fr,fc]) => fr===r && fc===c))
          td.classList.add('cell-just-swapped');

        tr.appendChild(td);
      }
      gridTable.appendChild(tr);
    }
  }

  // ── Drag-to-swap ───────────────────────────────────────────────────────────
  function attachDragHandlers(td) {
    td.draggable = true;

    td.addEventListener('dragstart', e => {
      dragSrc = { r: +td.dataset.r, c: +td.dataset.c, td };
      td.classList.add('dragging');
      // Ghost always shows just the student name (first span inside .cell-inner)
      const nameEl = td.querySelector('.cell-inner span:first-child') || td;
      dragGhost.textContent = nameEl.textContent || td.textContent;
      dragGhost.style.display = 'block';
      e.dataTransfer.setDragImage(dragGhost, -999, -999);
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', `${td.dataset.r},${td.dataset.c}`);
    });

    td.addEventListener('drag', e => {
      if (e.clientX === 0 && e.clientY === 0) return;
      dragGhost.style.left = (e.clientX + 14) + 'px';
      dragGhost.style.top  = (e.clientY - 16) + 'px';
    });

    td.addEventListener('dragend', () => {
      dragGhost.style.display = 'none';
      td.classList.remove('dragging');
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      dragSrc = null;
    });

    attachDropHandlers(td);
  }

  function attachDropOnlyHandlers(td) { attachDropHandlers(td); }

  function attachDropHandlers(td) {
    td.addEventListener('dragover', e => {
      e.preventDefault();
      if (!dragSrc) return;
      if (dragSrc.r === +td.dataset.r && dragSrc.c === +td.dataset.c) return;
      e.dataTransfer.dropEffect = 'move';
      td.classList.add('drag-over');
    });

    td.addEventListener('dragleave', () => td.classList.remove('drag-over'));

    td.addEventListener('drop', e => {
      e.preventDefault();
      td.classList.remove('drag-over');
      if (!dragSrc) return;
      const srcR = dragSrc.r, srcC = dragSrc.c;
      const dstR = +td.dataset.r, dstC = +td.dataset.c;
      if (srcR === dstR && srcC === dstC) return;
      if (!isSeat(dstR, dstC)) return;
      performSwap(srcR, srcC, dstR, dstC);
    });
  }

  function performSwap(r1, c1, r2, c2, isUndo = false) {
    const nameA  = resultGrid[r1][c1];
    const nameB  = resultGrid[r2][c2];
    const gradeA = gradeGrid[r1][c1];
    const gradeB = gradeGrid[r2][c2];
    const flagA  = flagGrid[r1][c1];
    const flagB  = flagGrid[r2][c2];

    // Swap names, grades, and flags together
    resultGrid[r1][c1] = nameB;  resultGrid[r2][c2] = nameA;
    gradeGrid[r1][c1]  = gradeB; gradeGrid[r2][c2]  = gradeA;
    flagGrid[r1][c1]   = flagB;  flagGrid[r2][c2]   = flagA;

    if (!isUndo) {
      swapHistory.push({ r1, c1, r2, c2, nameA, nameB, gradeA, gradeB, flagA, flagB });
      swapCount++;
    }
    syncUndoBtn();
    rebuildTable([[r1,c1],[r2,c2]]);
    updateSwapLog({ nameA, nameB, isUndo });
  }

  function updateSwapLog(info) {
    if (!info) {
      swapLogEl.innerHTML = swapCount > 0
        ? `<span class="swap-badge">${swapCount} swap${swapCount!==1?'s':''}</span><span class="swap-log-text">chart modified</span>`
        : `<span class="swap-log-text" style="opacity:0.4">no swaps yet</span>`;
      return;
    }
    const verb = info.isUndo ? 'undid swap of' : 'swapped';
    const a = info.nameA || 'empty seat';
    const b = info.nameB || 'empty seat';
    swapLogEl.innerHTML = `<span class="swap-badge">${swapCount} swap${swapCount!==1?'s':''}</span><span class="swap-log-text">${verb} <strong>${a}</strong> ↔ <strong>${b}</strong></span>`;
  }

  function syncUndoBtn() { btnUndo.disabled = swapHistory.length === 0; }

  btnUndo.addEventListener('click', () => {
    if (!swapHistory.length) return;
    const last = swapHistory.pop();
    swapCount = Math.max(0, swapCount - 1);
    // Restore name, grade, and flag
    resultGrid[last.r1][last.c1] = last.nameA;  resultGrid[last.r2][last.c2] = last.nameB;
    gradeGrid[last.r1][last.c1]  = last.gradeA; gradeGrid[last.r2][last.c2]  = last.gradeB;
    flagGrid[last.r1][last.c1]   = last.flagA;  flagGrid[last.r2][last.c2]   = last.flagB;
    syncUndoBtn();
    rebuildTable([[last.r1,last.c1],[last.r2,last.c2]]);
    updateSwapLog({ nameA: last.nameA, nameB: last.nameB, isUndo: true });
  });

  // ── Toggle details (grade badges + flag markers) ────────────────────────────
  btnToggle.addEventListener('click', () => {
    detailsVisible = !detailsVisible;
    if (detailsVisible) {
      gridTable.classList.remove('details-off');
      btnToggle.textContent = 'Hide Details';
      btnToggle.classList.add('active');
    } else {
      gridTable.classList.add('details-off');
      btnToggle.textContent = 'Show Details';
      btnToggle.classList.remove('active');
    }
  });

  // ── Download CSV ────────────────────────────────────────────────────────────
  // CSV output contains names only (no grade column) — same as v5
  btnDownload.addEventListener('click', () => {
    const csvRows = resultGrid.map(row =>
      row.map(cell => {
        if (cell && (cell.includes(',') || cell.includes('"') || cell.includes('\n')))
          return `"${cell.replace(/"/g, '""')}"`;
        return cell;
      }).join(',')
    );
    const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'seating-chart.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // ── Download PDF ────────────────────────────────────────────────────────────
  btnPdf.addEventListener('click', () => {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-CA', { year:'numeric', month:'long', day:'numeric' });
    const timeStr = now.toLocaleTimeString('en-CA', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
    printMeta.innerHTML =
      `${totalStudentsGlobal} students · ${totalSeatsGlobal} seats<br>` +
      `${assignedGlobal} assigned · ${totalSeatsGlobal - assignedGlobal} empty` +
      (swapCount > 0 ? `<br>${swapCount} manual swap${swapCount!==1?'s':''}` : '') +
      `<br>Generated ${dateStr} at ${timeStr}`;

    printHeader.style.display = 'block';
    setTimeout(() => {
      window.print();
      setTimeout(() => { printHeader.style.display = 'none'; }, 600);
    }, 80);
  });
</script>
</body>
</html>
